<!DOCTYPE html>
<html>
    <head>
        <title>Evaccum Condition Selector</title>
    	<meta charset="utf-8"/>
        <!-- pull in JATOS resources -->
        <script src="/assets/javascripts/jatos.js"></script>
        <style></style>
    </head>
    <body></body>
    <script>
        
        // will generate condition bins, the condition for this participant and move on to next component

        var num_conditions = 2;
        var num_condition_repeats = 25;

        // will need to run this twice if first run on server (see fail condition)
        initBatchConditions(num_conditions,num_condition_repeats);

        var id_number = getNextCondition();
        jatos.studySessionData["id_number"] = id_number;

        if (id_number > 1) {
            condition_bin = id_number % 2; 
        } else if (id_number == 1) {
            condition_bin = 1;
        } else if (id_number == 0) {
            condition_bin = 0;
        } else {
            console.log('id number: ',id_number);
            throw 'invalid id_number - must be 0 or greater';
        }
        jatos.studySessionData["condition_bin"] = condition_bin;
        console.log('condition_bin :',condition_bin)

        jatos.startNextComponent();
    
        ///////////////
        // functions //
        ///////////////

        function initBatchConditions(num_conditions,conditionCounts) {
            // Check if 'conditions' are not already in the batch session
            if (!jatos.batchSession.defined("/conditions")) {
                // Get the count of each condition
                var conditions = [];
                // Fill the array with conditions according to the counters
                for (this_cond = 0; this_cond < num_conditions; this_cond++) {
                    fillArrayWithValues(conditions, this_cond, conditionCounts)
                }
                // Put the conditions in the batch session
                jatos.batchSession.set("conditions", conditions)
                // may crash if this fail condition is triggered, but will have generated the conditions, so run this again and it should all work
                    .fail(initBatchConditions); // If it fails: try again
            }
        }
        function fillArrayWithValues(array, value, count) {
            for (var i = 0; i < count; i++) {
                array.push(value);
            }
        }
        function getNextCondition() {
            // Get the still available conditions from the Batch Session
            var conditions = jatos.batchSession.get("conditions");
            // If no more conditions throw an error
            if (conditions.length == 0) {
                throw "Max number of workers reached";
            }
            // Get a random condition
            var randomIndex = Math.floor(Math.random() * conditions.length);
            var randomCondition = conditions[randomIndex];
            // Delete the choosen condition from the array
            conditions.splice(randomIndex, 1);
            // Set the changed conditions array in the Batch Session.
            jatos.batchSession.set("conditions", conditions).fail(function () {
                randomCondition = getNextCondition(); // If it fails: try again
            });
            return randomCondition;
        }
    </script>
</html>
