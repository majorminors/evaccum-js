<!DOCTYPE html>
<html>
    <head>
        <title>EvAccum</title>
    	<meta charset="utf-8"/>
        <script src="jspsych-6.1.0/jspsych.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
		<script src="jspsych-6.1.0/plugins/jspsych-image-keyboard-response.js"></script>
		<script src="jspsych-6.1.0/plugins/jspsych-rdk.js"></script>
    	<script src="tools/exp_stimulus_array_generator.js"></script>
    	<script src="tools/coh_stimulus_array_generator.js"></script>
    	<script src="tools/rule_stimulus_array_generator.js"></script>
        <link href="tools/exp.css" rel="stylesheet" type="text/css"></link>
		<style></style>
    </head>
    <body></body>
    <script>

		/* use a random number generator to arbitrate between response mappings */
		if (((Math.floor(Math.random() * 100) + 1) % 2) === 0) {
			// the order of these variables are important because we index into them later, so:
			// if a random number generated between 1 and 100 is even then do this order
			/* keys */
			var resp_keys = ['a', 's'];
			/* cues */
			var cues = [
				{stimulus: "stimuli/1-3.png"},
				{stimulus: "stimuli/2-4.png"},
				{stimulus: "stimuli/3-1.png"},
				{stimulus: "stimuli/4-2.png"}
			];

		} else {
			// else (if the number is odd) do this order
			/* keys */
			var resp_keys = ['s', 'a'];
			/* cues */
			var cues = [
				{stimulus: "stimuli/3-1.png"},
				{stimulus: "stimuli/4-2.png"},
				{stimulus: "stimuli/1-3.png"},
				{stimulus: "stimuli/2-4.png"}
			];
		}

		/* coherence */
		var coherence_values = [0.8, 0.3]; // we will need to generate these from earlier psychophys. [0] needs to be easy, [1] needs to be hard


    	/* define parameters to pass into the stimulus_array_generator function */
   		var easy_rule = 10;
    	var hard_rule = 80;
    	var num_blocks = 20;
    	var num_trials_per_block = 64;
    	var num_cues = 4;
    	var num_motion_coherence = 8;

   		/* generate stimulus array with stimulus_array_generator function */
    	var exp_stim_array = exp_stimulus_array_generator(easy_rule, hard_rule, num_blocks, num_trials_per_block, num_cues, num_motion_coherence);

		/* initialise timeline array */
        var timeline =[];

		/* generate trial procedure */
		var block;
		var trial;
		var count = 0;
		for (block = 0; block < exp_stim_array.length; block++) { // equivalent to number of blocks (exp_stim_array[0-n]) - should = num_blocks
			for (trial = 0; trial < exp_stim_array[0].length; trial++) { // equivalent to number of trials per block (exp_stim_array[x][0-n]) - should = num_trials_per_block
				count++; // use this to track how many trials have happened in total
				i = exp_stim_array[block][trial]; // make this easier to call
				if (count === 1) {
					var exp_start_screen = {
						type: "html-keyboard-response",
						stimulus: "<p>Now we're ready to begin the experiment.</p><br>"+
							"<p>This will take about 40 minutes.</p><br>"+
							"<br><p>Press any key to begin.</p>"
					}
					timeline.push(exp_start_screen);
				}	

				if (count === 1 || (count-1) % 8 === 0) { // show this on the first trial, then every 8 - this assumes that a cue change happens after a number divisible by 8 otherwise your participant is going to have dots corresponding to a cue they haven't seen yet 
					var exp_cue = {
						type: 'image-keyboard-response',
						stimulus: cues[i.cue_dir-1].stimulus, // -1 because cue_dir goes from 1-4 and javascript indexes from 0-3
						choices: resp_keys,
						data: {experiment_part: 'experiment_cue'}
					}
					timeline.push(exp_cue);
				}

				var exp_fixation = { // do an rdk block with invisible dots (since the html doesn't line up with the rdk canvas, the fixation appears to jump around)
					type: 'rdk',
					background_color: "black",
					dot_color: "black", 
					aperture_type: 1,
					fixation_cross: true,
					fixation_cross_color: "white", 
					fixation_cross_thickness: 6,
					post_trial_gap: 0, 
					choices: jsPsych.NO_KEYS,
					correct_choice: "q",
					trial_duration: 300,
					data: {experiment_part: 'experiment_fixation'}
				}
				timeline.push(exp_fixation);

				var exp_rdk = {
					type: 'rdk', 
					background_color: "black",
					dot_color: "white", 
					aperture_type: 1,
					fixation_cross: true,
					fixation_cross_color: "white", 
					fixation_cross_thickness: 6,
					post_trial_gap: 0, 
					number_of_dots: 100,
					response_ends_trial: false,
					coherence: coherence_values[i.coh_difficulty-1], 
					move_distance: 2.5, // I've only approximated the MATLAB experiment here - that's 5 degrees per second (like .01 Hz/fps) this is in pixel lengths per second...
					dot_life: 7, // this is not the same as MATLAB - expressed in same units (frames of life), but MATLAB's 5 is visibly different to jsPsych's 5...
					choices: resp_keys,
					correct_choice: resp_keys[i.match_arrow-1],
					coherent_direction: i.dot_motion_dir_deg, 
					trial_duration: 1500,
					data: {experiment_part: 'experiment_rdk'}
				}
				var exp_feedback = { // you can use this for testing, otherwise comment out
					type: "html-keyboard-response",
					stimulus: function() {
						var last_rdk_accuracy = jsPsych.data.get().last(1).values()[0].correct; // dynamic var (runs throughout) asking for data.correct from last rdk block
						if (last_rdk_accuracy) { // if true (data.correct is boolean)
							return "<p>correct</p>";
						} else { // else if false
							return "<p>incorrect</p>"
						}
					},
					choices: jsPsych.NO_KEYS,
					trial_duration: 300,
					data: {experiment_part: 'experiment_feedback'}
				}
				timeline.push(exp_rdk, exp_feedback);
			}
		}

		/* initialise experiment */
        jsPsych.init({
            timeline: timeline,
			preload_images: cues.map(function(path) {return path.stimulus}), // get the path to the stimulus images (as an array) from the cues variable
            show_progress_bar: false,
            show_preload_progress_bar: false
        });

    </script>
</html>
