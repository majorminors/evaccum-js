<!DOCTYPE html>
<html>
    <head>
        <title>EvAccum</title>
    	<meta charset="utf-8"/>
        <script src="jspsych-6.1.0/jspsych.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
		<script src="jspsych-6.1.0/plugins/jspsych-image-keyboard-response.js"></script>
		<script src="jspsych-6.1.0/plugins/jspsych-rdk.js"></script>
    	<script src="tools/stimulus_array_generator.js"></script>
        <link href="tools/exp.css" rel="stylesheet" type="text/css"></link>
		<style></style>
    </head>
    <body></body>
    <script>

		/* keys */
		var resp_keys = ['a', 's'];

		/* coherence */
		var coherence_values = [0.8, 0.3];

		/* cues */
		var cues = [
			{stimulus: "stimuli/1-3.png"},
			{stimulus: "stimuli/2-4.png"},
			{stimulus: "stimuli/3-1.png"},
			{stimulus: "stimuli/4-2.png"}
		];

		var easy_coh = 70; 
		var hard_coh = 30;

    	/* define parameters to pass into the stimulus_array_generator function */
   		var easy_rule = 10;
    	var hard_rule = 80;
    	var num_blocks = 20;
    	var num_trials_per_block = 64;
    	var num_cues = 4;
    	var num_motion_coherence = 8;

   		/* generate stimulus array with stimulus_array_generator function */
    	var stim_array = stimulus_array_generator(easy_rule, hard_rule, num_blocks, num_trials_per_block, num_cues, num_motion_coherence);

		/* initialise timeline array */
        var timeline =[];

		/* generate trial procedure */
		var block;
		var trial;
		var count = 0;
		for (block = 0; block < stim_array.length; block++) { // equivalent to number of blocks (stim_array[0-n]) - should = num_blocks
			for (trial = 0; trial < stim_array[0].length; trial++) { // equivalent to number of trials per block (stim_array[x][0-n]) - should = num_trials_per_block
				count++; // use this to track how many trials have happened in total
				i = stim_array[block][trial]; // make this easier to call
	
				if (count === 1 || (count-1) % 8 === 0) { // show this on the first trial, then every 8 - this assumes that a cue change happens after a number divisible by 8 otherwise your participant is going to have dots corresponding to a cue they haven't seen yet 
					var cue = {
						type: 'image-keyboard-response',
						stimulus: cues[i.cue_dir-1].stimulus, // -1 because the cues go from 1-4 and javascript indexes from 0-3
						choices: resp_keys,
					}
					timeline.push(cue);
				}

				var fixation = { // do an rdk block with invisible dots (since the html doesn't line up with the rdk canvas, the fixation appears to jump around)
					type: 'rdk',
					background_color: "black",
					dot_color: "black", 
					aperture_type: 1,
					fixation_cross: true,
					fixation_cross_color: "white", 
					fixation_cross_thickness: 6,
					post_trial_gap: 0, 
					choices: jsPsych.NO_KEYS,
					correct_choice: "q",
					trial_duration: 300,
				}
				timeline.push(fixation);

				var rdk = {
					type: 'rdk', 
					background_color: "black",
					dot_color: "white", 
					aperture_type: 1,
					fixation_cross: true,
					fixation_cross_color: "white", 
					fixation_cross_thickness: 6,
					post_trial_gap: 0, 
					number_of_dots: 100,
					coherence: coherence_values[i.coh_difficulty-1], 
					move_distance: 2.5, // I've only approximated the MATLAB experiment here - that's 5 degrees per second (like .01 Hz/fps) this is in pixel lengths per second...
					dot_life: 7, // this is not the same as MATLAB - expressed in same units (frames of life), but MATLAB's 5 is visibly different to jsPsych's 5...
					choices: resp_keys,
					correct_choice: resp_keys[i.match_arrow-1],
					coherent_direction: i.dot_motion_dir_deg, 
					trial_duration: 1500,
					data: {test_part: 'rdk'}
				}
				var feedback = {
					type: "html-keyboard-response",
					stimulus: function() {
						var last_rdk_accuracy = jsPsych.data.get().last(1).values()[0].correct; // dynamic var (runs throughout) asking for data.correct from last rdk block
						if (last_last_accuracy) { // if true (data.correct is boolean)
							return "<p>correct</p>";
						} else { // else if false
							return "<p>incorrect</p>"
						}
					}
				}
				timeline.push(rdk, feedback);
			}
		}

		/* initialise experiment */
        jsPsych.init({
            timeline: timeline,
			preload_images: cues.map(function (path) {return path.stimulus}); // get the path to the stimulus images (as an array) from the cues variable
            show_progress_bar: false,
            show_preload_progress_bar: false
        });

    </script>
</html>
